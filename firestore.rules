// ============================================================================
// Firebase Firestore Security Rules for PlayerPath Coach Sharing
// ============================================================================
// DEPLOYMENT INSTRUCTIONS:
// 1. Go to Firebase Console: https://console.firebase.google.com
// 2. Select your project
// 3. Navigate to Firestore Database > Rules
// 4. Copy and paste this entire file
// 5. Click "Publish" to deploy the rules
// 6. Test the rules using the "Rules Playground" tab
// ============================================================================
// SECURITY NOTES:
// - All operations require authentication
// - Premium-only features enforced server-side
// - Coach permissions validated against folder settings
// - Invitation expiry enforced server-side
// - Comment permissions enforced for annotations
// ============================================================================

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================================================
    // HELPER FUNCTIONS
    // ========================================================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userID) {
      return request.auth.uid == userID;
    }
    
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    function isPremium() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isPremium == true;
    }
    
    function canAccessFolder(folderID) {
      let folder = get(/databases/$(database)/documents/sharedFolders/$(folderID)).data;
      return request.auth.uid == folder.ownerAthleteID 
          || request.auth.uid in folder.sharedWithCoachIDs;
    }
    
    function canUploadToFolder(folderID) {
      let folder = get(/databases/$(database)/documents/sharedFolders/$(folderID)).data;
      return request.auth.uid == folder.ownerAthleteID
          || (request.auth.uid in folder.sharedWithCoachIDs 
              && folder.permissions[request.auth.uid].canUpload == true);
    }
    
    function canDeleteFromFolder(folderID) {
      let folder = get(/databases/$(database)/documents/sharedFolders/$(folderID)).data;
      return request.auth.uid == folder.ownerAthleteID
          || (request.auth.uid in folder.sharedWithCoachIDs
              && folder.permissions[request.auth.uid].canDelete == true);
    }

    function canCommentOnFolder(folderID) {
      let folder = get(/databases/$(database)/documents/sharedFolders/$(folderID)).data;
      return request.auth.uid == folder.ownerAthleteID
          || (request.auth.uid in folder.sharedWithCoachIDs
              && folder.permissions[request.auth.uid].canComment == true);
    }

    function isInvitationNotExpired(expiresAt) {
      return request.time < expiresAt;
    }
    
    // ========================================================================
    // USER PROFILES
    // ========================================================================

    match /users/{userID} {
      // Anyone authenticated can read any user profile (for display names, etc.)
      allow read: if isAuthenticated();

      // Users can only write their own profile
      allow write: if isOwner(userID);

      // ======================================================================
      // ATHLETES (SUBCOLLECTION) - Cross-Device Sync
      // ======================================================================

      match /athletes/{athleteID} {
        // Read: Users can only read their own athletes
        allow read: if isAuthenticated() && isOwner(userID);

        // Create: Users can create athletes under their own profile
        // Must set correct userId in the document
        allow create: if isAuthenticated()
                      && isOwner(userID)
                      && request.resource.data.userId == userID;

        // Update: Users can only update their own athletes
        allow update: if isAuthenticated() && isOwner(userID);

        // Delete: Users can only delete their own athletes (soft delete)
        allow delete: if isAuthenticated() && isOwner(userID);
      }

      // ======================================================================
      // SEASONS (SUBCOLLECTION) - Cross-Device Sync
      // ======================================================================

      match /seasons/{seasonID} {
        // Read: Users can only read their own seasons
        allow read: if isAuthenticated() && isOwner(userID);

        // Create: Users can create seasons under their own profile
        // Must set correct athleteId in the document
        allow create: if isAuthenticated()
                      && isOwner(userID);

        // Update: Users can only update their own seasons
        allow update: if isAuthenticated() && isOwner(userID);

        // Delete: Users can only delete their own seasons (soft delete)
        allow delete: if isAuthenticated() && isOwner(userID);
      }

      // ======================================================================
      // GAMES (SUBCOLLECTION) - Cross-Device Sync
      // ======================================================================

      match /games/{gameID} {
        // Read: Users can only read their own games
        allow read: if isAuthenticated() && isOwner(userID);

        // Create: Users can create games under their own profile
        // Must set correct athleteId in the document
        allow create: if isAuthenticated()
                      && isOwner(userID);

        // Update: Users can only update their own games
        allow update: if isAuthenticated() && isOwner(userID);

        // Delete: Users can only delete their own games (soft delete)
        allow delete: if isAuthenticated() && isOwner(userID);
      }
    }

    // ========================================================================
    // SHARED FOLDERS
    // ========================================================================
    
    match /sharedFolders/{folderID} {
      // Read access: Owner or coaches with access
      allow read: if isAuthenticated() && canAccessFolder(folderID);
      
      // Create: Authenticated premium users can create folders
      // Must set themselves as owner
      allow create: if isAuthenticated() 
                    && isPremium() 
                    && request.resource.data.ownerAthleteID == request.auth.uid;
      
      // Update: Only the owner can update folder settings
      allow update: if isAuthenticated() 
                    && resource.data.ownerAthleteID == request.auth.uid;
      
      // Delete: Only the owner can delete folders
      allow delete: if isAuthenticated() 
                    && resource.data.ownerAthleteID == request.auth.uid;
    }
    
    // ========================================================================
    // VIDEOS
    // ========================================================================
    
    match /videos/{videoID} {
      // Read: Anyone with access to the folder
      allow read: if isAuthenticated() 
                  && canAccessFolder(resource.data.sharedFolderID);
      
      // Create: Users with upload permission
      allow create: if isAuthenticated() 
                    && canUploadToFolder(request.resource.data.sharedFolderID)
                    && request.resource.data.uploadedBy == request.auth.uid;
      
      // Update: Only the uploader can update video metadata
      allow update: if isAuthenticated() 
                    && resource.data.uploadedBy == request.auth.uid;
      
      // Delete: Owner of folder OR uploader OR coach with delete permission
      allow delete: if isAuthenticated() 
                    && (resource.data.uploadedBy == request.auth.uid
                        || canDeleteFromFolder(resource.data.sharedFolderID));
      
      // ======================================================================
      // VIDEO ANNOTATIONS (SUBCOLLECTION)
      // ======================================================================
      
      match /annotations/{annotationID} {
        // Read: Anyone with access to the video
        allow read: if isAuthenticated() &&
                    canAccessFolder(get(/databases/$(database)/documents/videos/$(videoID)).data.sharedFolderID);

        // Create: Only users with comment permission can create annotations
        allow create: if isAuthenticated()
                      && request.resource.data.userID == request.auth.uid
                      && canCommentOnFolder(get(/databases/$(database)/documents/videos/$(videoID)).data.sharedFolderID);
        
        // Update: Users can edit their own comments
        allow update: if isAuthenticated() 
                      && resource.data.userID == request.auth.uid;
        
        // Delete: Users can delete their own comments, or folder owner can delete any
        allow delete: if isAuthenticated() 
                      && (resource.data.userID == request.auth.uid
                          || get(/databases/$(database)/documents/sharedFolders/$(get(/databases/$(database)/documents/videos/$(videoID)).data.sharedFolderID)).data.ownerAthleteID == request.auth.uid);
      }
    }
    
    // ========================================================================
    // COACH ACCESS REVOCATIONS
    // ========================================================================

    match /coach_access_revocations/{revocationId} {
      // Read: Only the athlete who revoked access
      allow read: if isAuthenticated()
                  && resource.data.athleteID == request.auth.uid;

      // Create: Only folder owners can create revocations
      // This is created programmatically, not directly by users
      allow create: if isAuthenticated()
                    && request.resource.data.athleteID == request.auth.uid;

      // Update: System only (for email tracking)
      allow update: if false;

      // Delete: Only the athlete who created it
      allow delete: if isAuthenticated()
                    && resource.data.athleteID == request.auth.uid;
    }

    // ========================================================================
    // INVITATIONS
    // ========================================================================
    
    match /invitations/{invitationID} {
      // Read: Athlete who sent it OR coach with matching email
      // Only non-expired invitations can be read
      allow read: if isAuthenticated() &&
                  isInvitationNotExpired(resource.data.expiresAt) &&
                  (resource.data.athleteID == request.auth.uid
                   || resource.data.coachEmail == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.email);

      // Create: Premium athletes can send invitations
      // Must set expiresAt to a future timestamp
      allow create: if isAuthenticated()
                    && isPremium()
                    && request.resource.data.athleteID == request.auth.uid
                    && request.resource.data.keys().hasAll(['expiresAt'])
                    && isInvitationNotExpired(request.resource.data.expiresAt);

      // Update: Athlete who sent it OR coach with matching email can update
      // (For accepting/declining) - Only if not expired
      allow update: if isAuthenticated() &&
                    isInvitationNotExpired(resource.data.expiresAt) &&
                    (resource.data.athleteID == request.auth.uid
                     || resource.data.coachEmail == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.email);

      // Delete: Only the athlete who sent it
      allow delete: if isAuthenticated()
                    && resource.data.athleteID == request.auth.uid;
    }
  }
}
